---
import config from "../config.json";

// Pass messages to client side
const messages = config.savageMessages;
---

<div
  id="flashbang-overlay"
  class="hidden"
  data-messages={JSON.stringify(messages)}
>
  <div class="flash-content">
    <h1 id="flash-msg">NICE TRY</h1>
  </div>
</div>

<script>
  function initSavageFlashbang() {
    // Disable on localhost? Maybe keep it for fun.
    // if (window.location.hostname === "localhost") return;

    const overlay = document.getElementById("flashbang-overlay");
    const msgEl = document.getElementById("flash-msg");
    const messagesData = overlay?.dataset.messages;

    if (!overlay || !msgEl || !messagesData) return;

    const messages = JSON.parse(messagesData);
    let isFlashbanged = false;

    const triggerFlashbang = (e: Event) => {
      // If strictly needed to block default:
      if (e.type === "contextmenu") e.preventDefault();

      if (isFlashbanged) return;
      isFlashbanged = true;

      // Pick random message
      const randomMsg = messages[Math.floor(Math.random() * messages.length)];
      msgEl.innerText = randomMsg;

      // Show Overlay
      overlay.classList.remove("hidden");
      overlay.classList.add("active");

      // Audio Effect? (Optional, maybe later)

      // Duration: 3 seconds total
      // 1. Instant Whiteout (already handled by class add)
      // 2. Wait 3s
      setTimeout(() => {
        // Fade out
        overlay.classList.remove("active");
        overlay.classList.add("fading");

        setTimeout(() => {
          overlay.classList.add("hidden");
          overlay.classList.remove("fading");
          isFlashbanged = false;
        }, 1000); // Fade duration
      }, 2000); // Visible duration
    };

    // Right Click
    document.addEventListener("contextmenu", triggerFlashbang);

    // AGGRESSIVE DEVTOOLS BLOCKING
    // Use Capture Phase (true) to intercept before anyone else
    window.addEventListener(
      "keydown",
      (e) => {
        // Normalize
        const k = e.key.toUpperCase();
        const ctrl = e.ctrlKey || e.metaKey;
        const shift = e.shiftKey;

        // Block List
        const isBlocked =
          e.key === "F12" ||
          (ctrl && shift && ["I", "J", "C", "K", "U"].includes(k)) || // DevTools & Source
          (ctrl && k === "U") || // View Source
          (ctrl && k === "S"); // Save Page

        if (isBlocked) {
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
          triggerFlashbang(e);
          return false;
        }
      },
      true, // CAPTURE PHASE
    );

    // The Trap (Debugger Loop)
    setInterval(() => {
      const start = performance.now();
      debugger;
    }, 500);
  }

  initSavageFlashbang();
  document.addEventListener("astro:page-load", initSavageFlashbang);
</script>

<style>
  #flashbang-overlay {
    position: fixed;
    inset: 0;
    z-index: 999999;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none; /* Let clicks pass through when hidden */
    opacity: 0;
    transition: opacity 0.1s ease-out; /* Fast in */
  }

  #flashbang-overlay.active {
    opacity: 1;
    pointer-events: all; /* Block interactions */
  }

  #flashbang-overlay.fading {
    opacity: 0;
    transition: opacity 1s ease-in; /* Slow fade out */
    pointer-events: all;
  }

  #flashbang-overlay.hidden {
    display: none;
  }

  .flash-content h1 {
    font-family: "Fraunces", serif; /* Or maybe a blocky font? */
    font-weight: 900;
    font-size: 5vw; /* Huge */
    color: black;
    text-transform: uppercase;
    text-align: center;
    margin: 0;
    padding: 0 1rem;
    line-height: 1.1;
  }
</style>
